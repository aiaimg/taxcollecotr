{% extends "base_velzon.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Créer Dossier Fourrière" %}{% endblock %}

{% block extra_css %}
<link href="{% static 'css/contraventions.css' %}" rel="stylesheet" type="text/css" />
{% endblock %}

{% block pagetitle %}
<div class="row">
    <div class="col-12">
        <div class="page-title-box d-sm-flex align-items-center justify-content-between">
            <h4 class="mb-sm-0">{% trans "Nouveau Dossier de Fourrière" %}</h4>
            <div class="page-title-right">
                <ol class="breadcrumb m-0">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">{% trans "Tableau de bord" %}</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'contraventions:list' %}">{% trans "Contraventions" %}</a></li>
                    <li class="breadcrumb-item active">{% trans "Fourrière" %}</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">{% trans "Mise en Fourrière" %}</h5>
            </div>
            <div class="card-body">
                <form method="post" id="fourriereForm">
                    {% csrf_token %}
                    
                    <!-- Informations de la Contravention -->
                    <div class="alert alert-info mb-4">
                        <h6 class="alert-heading">{% trans "Contravention Associée" %}</h6>
                        <p class="mb-1"><strong>{% trans "N° PV:" %}</strong> {{ form.initial.contravention.numero_pv }}</p>
                        <p class="mb-1"><strong>{% trans "Véhicule:" %}</strong> 
                            {% if form.initial.contravention.vehicule %}
                                {{ form.initial.contravention.vehicule.plaque_immatriculation }}
                            {% else %}
                                {{ form.initial.contravention.vehicule_plaque_manuelle }}
                            {% endif %}
                        </p>
                        <p class="mb-0"><strong>{% trans "Infraction:" %}</strong> {{ form.initial.contravention.type_infraction.nom }}</p>
                    </div>

                    <!-- Lieu de la Fourrière -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3"><i class="ri-map-pin-line me-2"></i>{% trans "Lieu de la Fourrière" %}</h6>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_lieu_fourriere" class="form-label">{% trans "Nom de la Fourrière" %} <span class="text-danger">*</span></label>
                                {{ form.lieu_fourriere }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_type_vehicule" class="form-label">{% trans "Type de Véhicule" %} <span class="text-danger">*</span></label>
                                {{ form.type_vehicule }}
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="id_adresse_fourriere" class="form-label">{% trans "Adresse Complète" %} <span class="text-danger">*</span></label>
                                {{ form.adresse_fourriere }}
                            </div>
                        </div>
                    </div>

                    <!-- Tarifs -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3"><i class="ri-money-dollar-circle-line me-2"></i>{% trans "Tarifs" %}</h6>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_frais_transport_ariary" class="form-label">{% trans "Frais de Transport (Ar)" %}</label>
                                {{ form.frais_transport_ariary }}
                                <small class="text-muted">{% trans "Défaut: 20 000 Ar" %}</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_frais_gardiennage_journalier_ariary" class="form-label">{% trans "Frais de Gardiennage/Jour (Ar)" %}</label>
                                {{ form.frais_gardiennage_journalier_ariary }}
                                <small class="text-muted">{% trans "Défaut: 10 000 Ar/jour" %}</small>
                            </div>
                        </div>
                    </div>

                    <!-- Calcul Estimatif -->
                    <div class="alert alert-secondary">
                        <h6 class="alert-heading">{% trans "Estimation des Frais" %}</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>{% trans "Frais de Transport:" %}</strong> <span id="display_transport">20 000</span> Ar</p>
                                <p class="mb-1"><strong>{% trans "Frais de Gardiennage (10 jours):" %}</strong> <span id="display_gardiennage">100 000</span> Ar</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>{% trans "Amende:" %}</strong> {{ form.initial.contravention.montant_amende_ariary|floatformat:0 }} Ar</p>
                                <p class="mb-0"><strong>{% trans "Total Estimé:" %}</strong> <span id="display_total" class="text-primary fs-5">120 000</span> Ar</p>
                            </div>
                        </div>
                        <small class="text-muted">{% trans "* Les frais de gardiennage augmentent chaque jour" %}</small>
                    </div>

                    <!-- Notes -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="id_notes" class="form-label">{% trans "Notes" %}</label>
                                {{ form.notes }}
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-end gap-2">
                                <a href="{% url 'contraventions:list' %}" class="btn btn-light">
                                    <i class="ri-close-line me-1"></i>{% trans "Annuler" %}
                                </a>
                                <button type="submit" class="btn btn-warning">
                                    <i class="ri-truck-line me-1"></i>{% trans "Créer le Dossier" %}
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar Info -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">{% trans "Informations" %}</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <h6 class="alert-heading"><i class="ri-information-line me-2"></i>{% trans "Durée Minimale" %}</h6>
                    <p class="mb-0">{% trans "Le véhicule doit rester en fourrière au minimum 10 jours avant restitution." %}</p>
                </div>
                
                <div class="alert alert-info">
                    <h6 class="alert-heading"><i class="ri-money-dollar-circle-line me-2"></i>{% trans "Conditions de Restitution" %}</h6>
                    <ul class="mb-0">
                        <li>{% trans "Paiement de l'amende" %}</li>
                        <li>{% trans "Paiement des frais de fourrière" %}</li>
                        <li>{% trans "Durée minimale respectée" %}</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const transportInput = document.getElementById('id_frais_transport_ariary');
    const gardiennageInput = document.getElementById('id_frais_gardiennage_journalier_ariary');
    const amendeValue = {{ form.initial.contravention.montant_amende_ariary|default:0 }};
    
    function updateEstimation() {
        const transport = parseFloat(transportInput.value) || 20000;
        const gardiennage = parseFloat(gardiennageInput.value) || 10000;
        const gardiennage10jours = gardiennage * 10;
        const total = transport + gardiennage10jours + amendeValue;
        
        document.getElementById('display_transport').textContent = transport.toLocaleString('fr-FR');
        document.getElementById('display_gardiennage').textContent = gardiennage10jours.toLocaleString('fr-FR');
        document.getElementById('display_total').textContent = total.toLocaleString('fr-FR');
    }
    
    transportInput.addEventListener('input', updateEstimation);
    gardiennageInput.addEventListener('input', updateEstimation);
    
    updateEstimation();
});
</script>
{% endblock %}
