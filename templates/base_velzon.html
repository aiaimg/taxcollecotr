{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="{% get_current_language as LANGUAGE_CODE %}{{ LANGUAGE_CODE }}" {% block html %}data-layout="vertical" data-topbar="light" data-bs-theme="light" data-sidebar="dark" data-sidebar-size="lg" data-sidebar-image="none" data-preloader="disable" {% endblock html %}>
<head>
    <meta charset="utf-8" />
    <title>{% block title %}{% endblock title %} | Tax Collector - Administration</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="Tax Collector Administration System" name="description" />
    <meta content="Tax Collector Team" name="author" />
    <!-- App favicon -->
    <link rel="shortcut icon" href="{% static 'velzon/images/favicon.ico'%}">

    {% block css %}
    {% block extra_css %}
    {% endblock extra_css %}

    <!-- Layout config Js -->
    <script src="{% static 'velzon/js/layout.js'%}"></script>
    <!-- Bootstrap Css -->
    <link href="{% static 'velzon/css/bootstrap.min.css'%}" id="bootstrap-style" rel="stylesheet" type="text/css" />
    <!-- Icons Css -->
    <link href="{% static 'velzon/css/icons.min.css'%}" rel="stylesheet" type="text/css" />
    <!-- App Css-->
    <link href="{% static 'velzon/css/app.min.css'%}" id="app-style" rel="stylesheet" type="text/css" />
    <!-- custom Css-->
    <link href="{% static 'velzon/css/custom.min.css'%}" id="app-style" rel="stylesheet" type="text/css" />
    <!-- Branding Css -->
    <link href="{% static 'css/branding.css' %}" rel="stylesheet" type="text/css" />
    <!-- Profile Picture Css -->
    <link href="{% static 'css/profile-picture.css' %}" rel="stylesheet" type="text/css" />
    {% endblock css %}
</head>

<body>
    <!-- Begin page -->
    <div id="layout-wrapper">
        {% block header %}
        {% include "velzon/partials/topbar.html" %}
        {% endblock header %}
        
        {% block sidebar %}
        {% load role_tags %}
        {# Check agent roles first (agents can have is_staff=True but should get agent sidebar) #}
        {% if user|is_agent_government_user %}
            {# Agent Gouvernement: QR verification access #}
            {% include "velzon/partials/sidebar_agent_government.html" %}
        {% elif user|is_agent_partenaire_user %}
            {# Agent Partenaire: Cash collection access #}
            {% include "velzon/partials/sidebar_agent_partenaire.html" %}
        {% elif user.is_superuser or user.is_staff %}
            {# Administration Staff: Full administrative access (only if not an agent) #}
            {% include "velzon/partials/sidebar_administration.html" %}
        {% elif user.profile.user_type == 'company' %}
            {# Company Users: Fleet management access #}
            {% include "velzon/partials/sidebar_company.html" %}
        {% elif user.profile.user_type == 'public_institution' %}
            {# Public Institution Users: Fleet management access (similar to company) #}
            {% include "velzon/partials/sidebar_company.html" %}
        {% elif user.profile.user_type == 'international_organization' %}
            {# International Organization Users: Fleet management access (similar to company) #}
            {% include "velzon/partials/sidebar_company.html" %}
        {% else %}
            {# Client/Individual Users: Basic access #}
            {% include "velzon/partials/sidebar_client.html" %}
        {% endif %}
        {% endblock sidebar %}
        
        <!-- ============================================================== -->
        <!-- Start right Content here -->
        <!-- ============================================================== -->
        <div class="main-content">
            <div class="page-content">
                <div class="container-fluid">
                    {% block pagetitle %}
                    {% endblock pagetitle %}
                    
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    {% block content %}
                    {% endblock content %}
                </div>
                <!-- container-fluid -->
            </div>
            <!-- End Page-content -->

            {% block footer %}
            {% include "velzon/partials/footer.html" %}
            {% endblock footer %}
        </div>
        <!-- end main content-->
    </div>
    <!-- END layout-wrapper -->
    
    {% block extra_content %}        
    {% endblock extra_content %}
    
    <!-- Notification System -->
    {% include 'partials/notifications.html' %}
        
    {% block right_sidebar %}
    {% include "velzon/partials/customizer.html" %}
    {% endblock right_sidebar %}

    {% block javascript %}
    <!-- JAVASCRIPT -->
    <!-- Fixed library paths to match actual static structure -->
    <script src="{% static 'velzon/libs/bootstrap/js/bootstrap.bundle.min.js'%}"></script>
    <script src="{% static 'velzon/libs/simplebar/simplebar.min.js'%}"></script>
    <script src="{% static 'velzon/libs/node-waves/waves.min.js'%}"></script>
    <script src="{% static 'velzon/libs/feather-icons/feather.min.js'%}"></script>
    <script src="{% static 'velzon/js/pages/plugins/lord-icon-2.1.0.js'%}"></script>
    <script src="{% static 'velzon/js/plugins.js'%}"></script>

    {% block extra_js %}
    {% endblock extra_js %}

    <!-- App js -->
    <script src="{% static 'velzon/js/app.js'%}"></script>
    
    <!-- Topbar functionality fix -->
    <script src="{% static 'js/topbar-fix.js'%}"></script>
    
    <!-- Custom sidebar collapse fix -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Global tooltip initializer to avoid ReferenceError
        window.initializeTooltips = function() {
            if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.forEach(function (tooltipTriggerEl) {
                    new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }
        };

        // Auto-dismiss alerts after 5 seconds
        const alerts = document.querySelectorAll('.alert:not(.alert-permanent)');
        alerts.forEach(function(alert) {
            setTimeout(function() {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }, 5000); // 5 seconds
        });
        
        // Ensure Bootstrap collapse functionality works for sidebar menus
        const collapseElements = document.querySelectorAll('[data-bs-toggle="collapse"]');
        collapseElements.forEach(function(element) {
            element.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    const bsCollapse = new bootstrap.Collapse(target, {
                        toggle: true
                    });
                }
            });
        });

        // Auto-init tooltips after DOM ready
        initializeTooltips();
    });
    </script>
    {% endblock javascript %}

</body>
</html>