{% extends 'cms/base_public.html' %}
{% load i18n static %}

{% block title %}{% trans "Vérification QR Code" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/qr_verification.css' %}">
<link rel="stylesheet" href="{% static 'css/public_home_green.css' %}">
{% endblock %}

{% block content %}
<!-- Skip to main content link for keyboard navigation -->
<a href="#qr-main-content" class="skip-link visually-hidden-focusable">
    {% trans "Aller au contenu principal" %}
</a>

<!-- Hero Section for QR Verification -->
<section class="qr-hero-section" aria-labelledby="qr-hero-title" role="region">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8 text-center">
                <h1 id="qr-hero-title" class="qr-hero-title">
                    <i class="ri-qr-scan-2-line me-3" aria-hidden="true"></i>
                    {% trans "Vérification QR Code" %}
                </h1>
                <p class="qr-hero-subtitle">
                    {% trans "Vérifiez l'authenticité d'un QR code de paiement de taxe véhicule" %}
                </p>
            </div>
        </div>
    </div>
</section>

<div id="qr-main-content" class="qr-verification-page">
    <div class="qr-verification-container">

        <!-- Instructions -->
        <div class="instructions-card" role="region" aria-labelledby="instructions-title">
            <div class="instructions-title" id="instructions-title">
                <i class="ri-information-line" aria-hidden="true"></i>
                {% trans "Comment utiliser" %}
            </div>
            <ul class="instructions-list">
                <li>{% trans "Utilisez la caméra de votre appareil pour scanner le QR code automatiquement" %}</li>
                <li>{% trans "Ou saisissez manuellement le code QR dans le champ de texte" %}</li>
                <li>{% trans "Les informations du véhicule et du paiement s'afficheront si le code est valide" %}</li>
                <li>{% trans "Vous pouvez consulter les documents (assurance, carte grise) si disponibles" %}</li>
            </ul>
        </div>

        <!-- Main Card -->
        <div class="qr-main-card" role="region" aria-labelledby="scanner-title">
            <div class="qr-card-header">
                <h2 id="scanner-title">
                    <i class="ri-search-line me-2" aria-hidden="true"></i>
                    {% trans "Scanner QR Code" %}
                </h2>
            </div>
            <div class="qr-card-body">
                <!-- Scanner Mode Selection -->
                <div class="scanner-modes" role="tablist" aria-label="{% trans 'Mode de scan' %}">
                    <button type="button" class="scanner-mode-btn" id="mode-camera" role="tab" aria-selected="false" aria-controls="camera-scanner">
                        <i class="ri-camera-line" aria-hidden="true"></i>
                        <span>{% trans "Caméra" %}</span>
                    </button>
                    <button type="button" class="scanner-mode-btn active" id="mode-manual" role="tab" aria-selected="true" aria-controls="manual-input">
                        <i class="ri-keyboard-line" aria-hidden="true"></i>
                        <span>{% trans "Saisie manuelle" %}</span>
                    </button>
                </div>

                <!-- Camera Permission Alert -->
                <div class="camera-permission-alert" id="camera-permission-alert"></div>

                <!-- Camera Scanner Section -->
                <div class="qr-scanner-section">
                    <div class="camera-scanner-container" id="camera-scanner" role="tabpanel" aria-labelledby="mode-camera">
                        <div id="qr-reader"></div>
                        <div class="camera-controls">
                            <button type="button" class="camera-btn" id="start-camera-btn"
                                onclick="startCameraScanning()" aria-label="{% trans 'Démarrer la caméra' %}">
                                <i class="ri-play-line me-1" aria-hidden="true"></i>
                                {% trans "Démarrer" %}
                            </button>
                            <button type="button" class="camera-btn stop" id="stop-camera-btn"
                                onclick="stopCameraScanning()" style="display: none;" aria-label="{% trans 'Arrêter la caméra' %}">
                                <i class="ri-stop-line me-1" aria-hidden="true"></i>
                                {% trans "Arrêter" %}
                            </button>
                        </div>
                    </div>

                    <!-- Manual Input Section -->
                    <div class="manual-input-container active" id="manual-input" role="tabpanel" aria-labelledby="mode-manual">
                        <form id="qr-verification-form">
                            {% csrf_token %}
                            <div class="qr-input-wrapper">
                                <label for="qr-code-input" class="qr-input-label">
                                    <i class="ri-qr-code-line me-2" aria-hidden="true"></i>
                                    {% trans "Code QR" %}
                                </label>
                                <input type="text" class="qr-input" id="qr-code-input" name="qr_code"
                                    placeholder="{% trans 'Saisissez ou collez le code QR ici...' %}"
                                    autocomplete="off"
                                    aria-describedby="qr-input-help">
                                <div class="qr-input-help" id="qr-input-help">
                                    <i class="ri-lightbulb-line" aria-hidden="true"></i>
                                    <span>{% trans "Le code QR est une chaîne de caractères alphanumériques" %}</span>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="qr-action-buttons">
                    <button type="button" class="qr-btn qr-btn-primary" id="verify-btn" aria-label="{% trans 'Vérifier le QR Code' %}">
                        <i class="ri-search-line me-2" aria-hidden="true"></i>
                        {% trans "Vérifier le QR Code" %}
                    </button>
                    <button type="button" class="qr-btn qr-btn-secondary" id="clear-btn" onclick="clearInput()" aria-label="{% trans 'Effacer le champ' %}">
                        <i class="ri-close-line me-2" aria-hidden="true"></i>
                        {% trans "Effacer" %}
                    </button>
                </div>

                <!-- Loading State -->
                <div class="qr-loading" id="qr-loading" role="status" aria-live="polite">
                    <div class="spinner" aria-hidden="true"></div>
                    <p>{% trans "Vérification en cours..." %}</p>
                </div>
            </div>
        </div>

        <!-- Verification Results -->
        <div class="verification-result" id="verification-result" role="region" aria-live="polite" aria-atomic="true">
            <!-- Results will be displayed here -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Html5Qrcode Library for Camera Scanning -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<!-- QR Verification JavaScript -->
<script src="{% static 'js/qr_verification.js' %}"></script>

<script>
    // Set API endpoint URL for JavaScript
    window.QR_VERIFICATION_URL = '{% url "core:qr_verification" %}';

    // Clear input function
    function clearInput() {
        const input = document.getElementById('qr-code-input');
        if (input) {
            input.value = '';
            input.focus();
        }
        hideResults();
    }

    function hideResults() {
        const resultContainer = document.getElementById('verification-result');
        if (resultContainer) {
            resultContainer.classList.remove('active');
        }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function () {
        // Check if camera is available, if not start with manual mode
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            const manualBtn = document.getElementById('mode-manual');
            const cameraBtn = document.getElementById('mode-camera');
            if (manualBtn) {
                manualBtn.click();
            }
            if (cameraBtn) {
                cameraBtn.disabled = true;
                cameraBtn.title = 'Camera non supportée par votre navigateur';
                cameraBtn.style.opacity = '0.5';
                cameraBtn.style.cursor = 'not-allowed';
            }
        }
    });
</script>
{% endblock %}