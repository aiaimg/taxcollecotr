{% extends "base_velzon.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Tableau de Bord" %}{% endblock title %}

{% block pagetitle %}
<div class="row">
    <div class="col-12">
        <div class="page-title-box d-sm-flex align-items-center justify-content-between">
            <h4 class="mb-sm-0">{% trans "Tableau de Bord" %}</h4>
            <div class="page-title-right">
                <ol class="breadcrumb m-0">
                    <li class="breadcrumb-item"><a href="javascript: void(0);">{% trans "Tax Collector" %}</a></li>
                    <li class="breadcrumb-item active">{% trans "Tableau de Bord" %}</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock pagetitle %}

{% block content %}
<div class="row">
    <div class="col">
        <div class="h-100">
            <div class="row mb-3 pb-1">
                <div class="col-12">
                    <div class="d-flex align-items-lg-center flex-lg-row flex-column">
                        <div class="flex-grow-1">
                            <h4 class="fs-16 mb-1">{% trans "Bonjour" %}, {{ user.get_full_name|default:user.username }}!</h4>
                            <p class="text-muted mb-0">{% trans "Voici un aperçu de votre système de collecte de taxes." %}</p>
                        </div>
                        <div class="mt-3 mt-lg-0">
                            <form action="javascript:void(0);">
                                <div class="row g-3 mb-0 align-items-center">
                                    <div class="col-sm-auto">
                                        <div class="input-group">
                                            <input type="text" class="form-control border-0 dash-filter-picker shadow" data-provider="flatpickr" data-range-date="true" data-date-format="d M, Y" data-deafult-date="01 {{ current_month }} to 31 {{ current_month }}">
                                            <div class="input-group-text bg-primary border-primary text-white">
                                                <i class="ri-calendar-2-line"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Reminders Widget -->
            {% if not is_admin %}
                <div class="row mb-3">
                    <div class="col-12">
                        {% include "partials/payment_reminders_widget.html" %}
                    </div>
                </div>
            {% endif %}

            <div class="row">
                <div class="col-xl-3 col-md-6">
                    <div class="card card-animate">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1 overflow-hidden">
                                    <p class="text-uppercase fw-medium text-muted text-truncate mb-0">{% trans "Total Véhicules" %}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <h5 class="text-success fs-14 mb-0">
                                        <i class="ri-arrow-right-up-line fs-13 align-middle"></i> +16.24 %
                                    </h5>
                                </div>
                            </div>
                            <div class="d-flex align-items-end justify-content-between mt-4">
                                <div>
                                    <h4 class="fs-22 fw-semibold ff-secondary mb-4"><span class="counter-value" data-target="{{ total_vehicles }}">0</span></h4>
                                    <a href="{% url 'vehicles:vehicle_list' %}" class="text-decoration-underline">{% trans "Voir les véhicules" %}</a>
                                </div>
                                <div class="avatar-sm flex-shrink-0">
                                    <span class="avatar-title bg-success-subtle rounded fs-3">
                                        <i class="ri-car-line text-success"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6">
                    <div class="card card-animate">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1 overflow-hidden">
                                    <p class="text-uppercase fw-medium text-muted text-truncate mb-0">{% trans "Paiements du Mois" %}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <h5 class="text-danger fs-14 mb-0">
                                        <i class="ri-arrow-right-down-line fs-13 align-middle"></i> -3.57 %
                                    </h5>
                                </div>
                            </div>
                            <div class="d-flex align-items-end justify-content-between mt-4">
                                <div>
                                    <h4 class="fs-22 fw-semibold ff-secondary mb-4">Ar <span class="counter-value" data-target="{{ monthly_payments }}">0</span></h4>
                                    <a href="{% url 'payments:list' %}" class="text-decoration-underline">{% trans "Voir les paiements" %}</a>
                                </div>
                                <div class="avatar-sm flex-shrink-0">
                                    <span class="avatar-title bg-info-subtle rounded fs-3">
                                        <i class="ri-money-dollar-circle-line text-info"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6">
                    <div class="card card-animate">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1 overflow-hidden">
                                    <p class="text-uppercase fw-medium text-muted text-truncate mb-0">{% trans "Utilisateurs Actifs" %}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <h5 class="text-success fs-14 mb-0">
                                        <i class="ri-arrow-right-up-line fs-13 align-middle"></i> +29.08 %
                                    </h5>
                                </div>
                            </div>
                            <div class="d-flex align-items-end justify-content-between mt-4">
                                <div>
                                    <h4 class="fs-22 fw-semibold ff-secondary mb-4"><span class="counter-value" data-target="{{ active_users }}">0</span></h4>
                                    <a href="{% url 'administration:user_list' %}" class="text-decoration-underline">{% trans "Gérer les utilisateurs" %}</a>
                                </div>
                                <div class="avatar-sm flex-shrink-0">
                                    <span class="avatar-title bg-warning-subtle rounded fs-3">
                                        <i class="ri-user-3-line text-warning"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6">
                    <div class="card card-animate">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1 overflow-hidden">
                                    <p class="text-uppercase fw-medium text-muted text-truncate mb-0">{% trans "Notifications" %}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <h5 class="text-muted fs-14 mb-0">
                                        +0.00 %
                                    </h5>
                                </div>
                            </div>
                            <div class="d-flex align-items-end justify-content-between mt-4">
                                <div>
                                    <h4 class="fs-22 fw-semibold ff-secondary mb-4"><span class="counter-value" data-target="165.89">0</span>k </h4>
                                    <a href="{% url 'notifications:list' %}" class="text-decoration-underline">{% trans "Voir les notifications" %}</a>
                                </div>
                                <div class="avatar-sm flex-shrink-0">
                                    <span class="avatar-title bg-primary-subtle rounded fs-3">
                                        <i class="ri-notification-3-line text-primary"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-xl-8">
                    <div class="card">
                        <div class="card-header border-0 align-items-center d-flex">
                            <h4 class="card-title mb-0 flex-grow-1">{% trans "Revenus" %}</h4>
                            <div>
                                <button type="button" class="btn btn-soft-secondary btn-sm">
                                    {% trans "TOUS" %}
                                </button>
                                <button type="button" class="btn btn-soft-secondary btn-sm">
                                    {% trans "1M" %}
                                </button>
                                <button type="button" class="btn btn-soft-secondary btn-sm">
                                    {% trans "6M" %}
                                </button>
                                <button type="button" class="btn btn-soft-primary btn-sm">
                                    {% trans "1A" %}
                                </button>
                            </div>
                        </div>

                        <div class="card-header p-0 border-0 bg-light-subtle">
                            <div class="row g-0 text-center">
                                <div class="col-6 col-sm-3">
                                    <div class="p-3 border border-dashed border-start-0">
                                        <h5 class="mb-1"><span class="counter-value" data-target="{{ today_payments }}">0</span></h5>
                                        <p class="text-muted mb-0">{% trans "Paiements Aujourd'hui" %}</p>
                                    </div>
                                </div>
                                <div class="col-6 col-sm-3">
                                    <div class="p-3 border border-dashed border-start-0">
                                        <h5 class="mb-1">Ar <span class="counter-value" data-target="{{ today_revenue }}">0</span></h5>
                                        <p class="text-muted mb-0">{% trans "Revenus Aujourd'hui" %}</p>
                                    </div>
                                </div>
                                <div class="col-6 col-sm-3">
                                    <div class="p-3 border border-dashed border-start-0">
                                        <h5 class="mb-1"><span class="counter-value" data-target="{{ total_vehicles }}">0</span></h5>
                                        <p class="text-muted mb-0">{% trans "Véhicules Totaux" %}</p>
                                    </div>
                                </div>
                                <div class="col-6 col-sm-3">
                                    <div class="p-3 border border-dashed border-start-0 border-end-0">
                                        <h5 class="mb-1 text-success"><span class="counter-value" data-target="{{ active_users }}">0</span></h5>
                                        <p class="text-muted mb-0">{% trans "Utilisateurs Actifs" %}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card-body p-0 pb-2">
                            <div class="w-100">
                                <div id="customer_impression_charts" data-colors='["--vz-primary", "--vz-success", "--vz-danger"]' class="apex-charts" dir="ltr"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-4">
                    <div class="card card-height-100">
                        <div class="card-header align-items-center d-flex">
                            <h4 class="card-title mb-0 flex-grow-1">{% trans "Activités Récentes" %}</h4>
                            <div class="flex-shrink-0">
                                <button type="button" class="btn btn-soft-primary btn-sm">
                                    <i class="ri-file-list-3-line align-middle"></i> {% trans "Générer Rapport" %}
                                </button>
                            </div>
                        </div>

                        <div class="card-body">
                            <div data-simplebar style="max-height: 350px;" class="px-3 mx-n3">
                                <div class="vstack gap-3">
                                    {% for payment in recent_payments %}
                                    <div class="d-flex position-relative">
                                        <div class="avatar-xs d-block flex-shrink-0 me-3">
                                            <span class="avatar-title rounded-circle fs-16 bg-success-subtle text-success">
                                                <i class="ri-money-dollar-circle-line"></i>
                                            </span>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1 fs-13">{% trans "Paiement reçu" %} - {{ payment.vehicule.plaque_immatriculation }}</h6>
                                            <p class="mb-0 fs-12 text-muted">
                                                <i class="mdi mdi-clock-outline"></i> {{ payment.date_paiement|timesince }} {% trans "ago" %}
                                            </p>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="d-flex position-relative">
                                        <div class="avatar-xs d-block flex-shrink-0 me-3">
                                            <span class="avatar-title rounded-circle fs-16 bg-info-subtle text-info">
                                                <i class="ri-information-line"></i>
                                            </span>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1 fs-13">{% trans "Aucune activité récente" %}</h6>
                                            <p class="mb-0 fs-12 text-muted">
                                                <i class="mdi mdi-clock-outline"></i> {% trans "En attente de nouvelles activités" %}
                                            </p>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Additional Charts Section -->
                <div class="row">
                    <div class="col-xl-6">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title mb-0">{% trans "Méthodes de Paiement" %}</h4>
                            </div>
                            <div class="card-body">
                                <div id="payment_methods_chart" data-colors='["--vz-primary", "--vz-info", "--vz-warning", "--vz-success"]' class="apex-charts" dir="ltr"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-6">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title mb-0">{% trans "Types de Véhicules" %}</h4>
                            </div>
                            <div class="card-body">
                                <div id="vehicle_types_chart" data-colors='["--vz-primary", "--vz-info", "--vz-warning", "--vz-success", "--vz-danger"]' class="apex-charts" dir="ltr"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<!-- apexcharts -->
<script src="{% static 'velzon/libs/apexcharts/apexcharts.min.js' %}"></script>

<!-- Vector map-->
<script src="{% static 'velzon/libs/jsvectormap/jsvectormap.min.js' %}"></script>
<script src="{% static 'velzon/libs/jsvectormap/maps/world-merc.js' %}"></script>

<!--Swiper slider js-->
<script src="{% static 'velzon/libs/swiper/swiper-bundle.min.js' %}"></script>

<!-- Dashboard init -->
<script src="{% static 'velzon/js/pages/dashboard-ecommerce.init.js' %}"></script>

<script>
// Monthly Revenue Chart Data
var monthlyRevenueData = [
    {% for item in monthly_revenue %}
    {
        month: '{{ item.month }}',
        revenue: {{ item.revenue }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// Payment Methods Chart Data
var paymentMethodsData = [
    {% for method in payment_methods %}
    {
        name: '{{ method.methode_paiement }}',
        count: {{ method.count }},
        total: {{ method.total }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// Vehicle Types Chart Data
var vehicleTypesData = [
    {% for type in vehicle_types %}
    {
        type: '{{ type.type_vehicule }}',
        count: {{ type.count }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// Initialize charts when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Monthly Revenue Chart
    if (monthlyRevenueData.length > 0) {
        var revenueChartOptions = {
            series: [{
                name: '{% trans "Revenus" %}',
                data: monthlyRevenueData.map(item => item.revenue)
            }],
            chart: {
                height: 350,
                type: 'line',
                toolbar: {
                    show: false
                }
            },
            dataLabels: {
                enabled: false
            },
            stroke: {
                curve: 'smooth',
                width: 2
            },
            xaxis: {
                categories: monthlyRevenueData.map(item => item.month)
            },
            yaxis: {
                labels: {
                    formatter: function(value) {
                        return 'Ar ' + value.toLocaleString();
                    }
                }
            },
            colors: ['#0ab39c'],
            grid: {
                borderColor: '#f1f1f1'
            }
        };
        
        var revenueChart = new ApexCharts(document.querySelector("#customer_impression_charts"), revenueChartOptions);
        revenueChart.render();
    }
    
    // Payment Methods Chart
    if (paymentMethodsData.length > 0) {
        var paymentMethodsChartOptions = {
            series: paymentMethodsData.map(item => item.count),
            chart: {
                height: 350,
                type: 'donut'
            },
            labels: paymentMethodsData.map(item => item.name),
            colors: ['#405189', '#0ab39c', '#f7b84b', '#f06548'],
            legend: {
                position: 'bottom'
            },
            dataLabels: {
                enabled: true,
                formatter: function(val, opts) {
                    return opts.w.config.series[opts.seriesIndex] + ' (' + val.toFixed(1) + '%)'
                }
            }
        };
        
        var paymentMethodsChart = new ApexCharts(document.querySelector("#payment_methods_chart"), paymentMethodsChartOptions);
        paymentMethodsChart.render();
    }
    
    // Vehicle Types Chart
    if (vehicleTypesData.length > 0) {
        var vehicleTypesChartOptions = {
            series: [{
                name: '{% trans "Nombre de Véhicules" %}',
                data: vehicleTypesData.map(item => item.count)
            }],
            chart: {
                height: 350,
                type: 'bar'
            },
            xaxis: {
                categories: vehicleTypesData.map(item => item.type)
            },
            colors: ['#405189'],
            plotOptions: {
                bar: {
                    borderRadius: 4,
                    horizontal: false
                }
            },
            dataLabels: {
                enabled: true
            }
        };
        
        var vehicleTypesChart = new ApexCharts(document.querySelector("#vehicle_types_chart"), vehicleTypesChartOptions);
        vehicleTypesChart.render();
    }
});
</script>
{% endblock extra_js %}