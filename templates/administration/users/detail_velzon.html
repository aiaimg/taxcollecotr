{% extends "administration/base_admin_velzon.html" %}
{% load static %}

{% block title %}{{ user_obj.username }} - User Detail - Admin Console{% endblock %}

{% block pagetitle %}
<div class="row">
    <div class="col-12">
        <div class="page-title-box d-sm-flex align-items-center justify-content-between">
            <h4 class="mb-sm-0">User Details</h4>
            <div class="page-title-right">
                <ol class="breadcrumb m-0">
                    <li class="breadcrumb-item"><a href="{% url 'administration:dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'administration:user_list' %}">Users</a></li>
                    <li class="breadcrumb-item active">{{ user_obj.username }}</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="card-title mb-0">{{ user_obj.username }}</h5>
                        <div class="mt-2">
                            {% if user_obj.is_active %}
                            <span class="badge badge-soft-success">Active</span>
                            {% else %}
                            <span class="badge badge-soft-danger">Inactive</span>
                            {% endif %}
                            {% if user_obj.is_staff %}
                            <span class="badge badge-soft-primary">Staff</span>
                            {% endif %}
                            {% if user_obj.is_superuser %}
                            <span class="badge badge-soft-warning">Superuser</span>
                            {% endif %}
                            {% if user_obj.profile %}
                            <span class="badge badge-soft-info">{{ user_obj.profile.get_verification_status_display }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-auto">
                        <a href="{% url 'administration:user_edit' user_obj.id %}" class="btn btn-primary btn-sm">
                            <i class="ri-edit-line align-bottom me-1"></i> Edit User
                        </a>
                        <button class="btn btn-warning btn-sm" onclick="resetPassword()">
                            <i class="ri-lock-password-line align-bottom me-1"></i> Reset Password
                        </button>
                        <button 
                            class="btn {% if user_obj.is_active %}btn-danger{% else %}btn-success{% endif %} btn-sm" 
                            onclick="toggleUserStatus()"
                        >
                            <i class="ri-{% if user_obj.is_active %}lock-line{% else %}unlock-line{% endif %} align-bottom me-1"></i>
                            {% if user_obj.is_active %}Deactivate{% else %}Activate{% endif %}
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Basic Information -->
                    <div class="col-lg-6">
                        <div class="card border">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0"><i class="ri-user-line me-1"></i> Basic Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-borderless mb-0">
                                        <tbody>
                                            <tr>
                                                <td class="fw-medium">Username:</td>
                                                <td>{{ user_obj.username }}</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-medium">Full Name:</td>
                                                <td>{{ user_obj.get_full_name|default:"-" }}</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-medium">Email:</td>
                                                <td>{{ user_obj.email|default:"-" }}</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-medium">Date Joined:</td>
                                                <td>{{ user_obj.date_joined|date:"F d, Y H:i" }}</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-medium">Last Login:</td>
                                                <td>
                                                    {% if user_obj.last_login %}
                                                    {{ user_obj.last_login|date:"F d, Y H:i" }}
                                                    {% else %}
                                                    Never
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Information -->
                    {% if user_obj.profile %}
                    <div class="col-lg-6">
                        <div class="card border">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0"><i class="ri-profile-line me-1"></i> Profile Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-borderless mb-0">
                                        <tbody>
                                            <tr>
                                                <td class="fw-medium">User Type:</td>
                                                <td>{{ user_obj.profile.get_user_type_display }}</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-medium">Verification Status:</td>
                                                <td>
                                                    <span class="badge badge-soft-{{ user_obj.profile.verification_status }}">
                                                        {{ user_obj.profile.get_verification_status_display }}
                                                    </span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="fw-medium">Phone:</td>
                                                <td>{{ user_obj.profile.telephone|default:"-" }}</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-medium">Preferred Language:</td>
                                                <td>{{ user_obj.profile.get_langue_preferee_display }}</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-medium">Profile Created:</td>
                                                <td>{{ user_obj.profile.created_at|date:"F d, Y" }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Admin Profile Information -->
                    {% if admin_profile %}
                    <div class="col-lg-6">
                        <div class="card border">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0"><i class="ri-admin-line me-1"></i> Admin Profile</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-borderless mb-0">
                                        <tbody>
                                            <tr>
                                                <td class="fw-medium">2FA Enabled:</td>
                                                <td>
                                                    {% if admin_profile.is_2fa_enabled %}
                                                    <span class="badge badge-soft-success">Yes</span>
                                                    {% else %}
                                                    <span class="badge badge-soft-warning">No</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="fw-medium">IP Whitelist:</td>
                                                <td>
                                                    {% if admin_profile.is_ip_whitelist_enabled %}
                                                    <span class="badge badge-soft-success">Enabled</span>
                                                    {% else %}
                                                    <span class="badge badge-soft-secondary">Disabled</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="fw-medium">Last Login IP:</td>
                                                <td>{{ admin_profile.last_login_ip|default:"-" }}</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-medium">Failed Login Attempts:</td>
                                                <td>{{ admin_profile.failed_login_attempts }}</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-medium">Theme Preference:</td>
                                                <td>{{ admin_profile.get_theme_preference_display }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Statistics -->
                    <div class="col-lg-6">
                        <div class="card border">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0"><i class="ri-bar-chart-line me-1"></i> Statistics</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-borderless mb-0">
                                        <tbody>
                                            <tr>
                                                <td class="fw-medium">Total Vehicles:</td>
                                                <td>{{ total_vehicles }}</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-medium">Total Payments:</td>
                                                <td>{{ total_payments }}</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-medium">Completed Payments:</td>
                                                <td>{{ total_paid }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Permissions & Groups -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card border">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h6 class="card-title mb-0"><i class="ri-shield-key-line me-1"></i> Permissions & Groups</h6>
                                <a href="{% url 'administration:user_permissions' user_obj.id %}" class="btn btn-primary btn-sm">
                                    <i class="ri-settings-line me-1"></i> Manage Permissions
                                </a>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="mb-3">Django Groups</h6>
                                        {% if user_obj.groups.all %}
                                        <div class="d-flex flex-wrap gap-1">
                                            {% for group in user_obj.groups.all %}
                                            <span class="badge badge-soft-primary">{{ group.name }}</span>
                                            {% endfor %}
                                        </div>
                                        {% else %}
                                        <p class="text-muted">No groups assigned</p>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="mb-3">Custom Permission Groups</h6>
                                        {% if user_obj.custom_permission_groups.all %}
                                        <div class="d-flex flex-wrap gap-1">
                                            {% for group in user_obj.custom_permission_groups.all %}
                                            <span class="badge badge-soft-success">{{ group.name }}</span>
                                            {% endfor %}
                                        </div>
                                        {% else %}
                                        <p class="text-muted">No custom groups assigned</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vehicles -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card border">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h6 class="card-title mb-0"><i class="ri-car-line me-1"></i> Vehicles ({{ total_vehicles }})</h6>
                                {% if total_vehicles > 10 %}
                                <a href="{% url 'administration:vehicle_type_list' %}?search={{ user_obj.username }}" class="btn btn-outline-primary btn-sm">
                                    View All Vehicles
                                </a>
                                {% endif %}
                            </div>
                            <div class="card-body">
                                {% if vehicles %}
                                <div class="table-responsive">
                                    <table class="table table-nowrap align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th>License Plate</th>
                                                <th>Type</th>
                                                <th>Category</th>
                                                <th>Status</th>
                                                <th>Registered</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for vehicle in vehicles %}
                                            <tr>
                                                <td><strong>{{ vehicle.plaque_immatriculation }}</strong></td>
                                                <td>{{ vehicle.get_type_vehicule_display }}</td>
                                                <td>{{ vehicle.get_categorie_vehicule_display }}</td>
                                                <td>
                                                    {% if vehicle.est_actif %}
                                                    <span class="badge badge-soft-success">Active</span>
                                                    {% else %}
                                                    <span class="badge badge-soft-danger">Inactive</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ vehicle.created_at|date:"Y-m-d" }}</td>
                                                <td>
                                                    <a href="{% url 'administration:vehicle_type_detail' vehicle.plaque_immatriculation %}" class="btn btn-sm btn-outline-primary">
                                                        <i class="ri-eye-line"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <div class="text-center py-4">
                                    <i class="ri-information-line text-muted" style="font-size: 2rem;"></i>
                                    <p class="text-muted mt-2">No vehicles registered</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Payments -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card border">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h6 class="card-title mb-0"><i class="ri-money-dollar-circle-line me-1"></i> Recent Payments ({{ total_payments }})</h6>
                                {% if total_payments > 10 %}
                                <a href="{% url 'administration:payment_management' %}?search={{ user_obj.username }}" class="btn btn-outline-primary btn-sm">
                                    View All Payments
                                </a>
                                {% endif %}
                            </div>
                            <div class="card-body">
                                {% if payments %}
                                <div class="table-responsive">
                                    <table class="table table-nowrap align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Transaction ID</th>
                                                <th>Vehicle</th>
                                                <th>Amount</th>
                                                <th>Method</th>
                                                <th>Status</th>
                                                <th>Date</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for payment in payments %}
                                            <tr>
                                                <td><code>{{ payment.transaction_id }}</code></td>
                                                <td>{{ payment.vehicule.plaque_immatriculation }}</td>
                                                <td>{{ payment.montant_paye_ariary|floatformat:0 }} Ar</td>
                                                <td>{{ payment.get_methode_paiement_display }}</td>
                                                <td>
                                                    <span class="badge badge-soft-{{ payment.statut }}">
                                                        {{ payment.get_statut_display }}
                                                    </span>
                                                </td>
                                                <td>{{ payment.created_at|date:"Y-m-d H:i" }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <div class="text-center py-4">
                                    <i class="ri-information-line text-muted" style="font-size: 2rem;"></i>
                                    <p class="text-muted mt-2">No payments found</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card border">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0"><i class="ri-history-line me-1"></i> Recent Activity</h6>
                            </div>
                            <div class="card-body">
                                {% if recent_activity %}
                                <div class="activity-feed">
                                    {% for log in recent_activity %}
                                    <div class="d-flex align-items-start mb-3">
                                        <div class="flex-shrink-0">
                                            <div class="avatar-xs">
                                                <span class="avatar-title bg-soft-primary text-primary rounded-circle">
                                                    {% if log.action == 'CREATE' %}
                                                    <i class="ri-add-circle-line"></i>
                                                    {% elif log.action == 'UPDATE' %}
                                                    <i class="ri-edit-line"></i>
                                                    {% elif log.action == 'DELETE' %}
                                                    <i class="ri-delete-bin-line"></i>
                                                    {% elif log.action == 'LOGIN' %}
                                                    <i class="ri-login-circle-line"></i>
                                                    {% elif log.action == 'LOGOUT' %}
                                                    <i class="ri-logout-circle-line"></i>
                                                    {% elif log.action == 'PAYMENT' %}
                                                    <i class="ri-money-dollar-circle-line"></i>
                                                    {% else %}
                                                    <i class="ri-information-line"></i>
                                                    {% endif %}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex-grow-1 ms-3">
                                            <h6 class="mb-1">{{ log.get_action_display }} - {{ log.table_concernee }}</h6>
                                            <p class="text-muted mb-1">{{ log.date_action|date:"F d, Y H:i" }}</p>
                                            {% if log.adresse_ip %}
                                            <small class="text-muted">IP: {{ log.adresse_ip }}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <div class="text-center py-4">
                                    <i class="ri-information-line text-muted" style="font-size: 2rem;"></i>
                                    <p class="text-muted mt-2">No recent activity</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleUserStatus() {
    if (!confirm('Are you sure you want to {% if user_obj.is_active %}deactivate{% else %}activate{% endif %} this user?')) {
        return;
    }
    
    fetch('{% url "administration:user_toggle_status" user_obj.id %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error toggling user status');
        console.error(error);
    });
}

function resetPassword() {
    {% if user_obj.email %}
    if (!confirm('Send password reset email to {{ user_obj.email }}?')) {
        return;
    }
    
    fetch('{% url "administration:user_reset_password" user_obj.id %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error sending password reset email');
        console.error(error);
    });
    {% else %}
    alert('This user does not have an email address configured');
    {% endif %}
}
</script>
{% endblock %}