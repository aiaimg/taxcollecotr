{% extends "administration/base_admin.html" %}
{% load static %}

{% block title %}User Management - Admin Console{% endblock %}

{% block breadcrumbs %}
<nav class="breadcrumbs">
    <a href="{% url 'administration:dashboard' %}">Dashboard</a>
    <span class="separator">/</span>
    <span>Users</span>
</nav>
{% endblock %}

{% block content %}
<div class="users-management">
    <div class="page-header">
        <h1>User Management</h1>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="exportUsers('csv')">
                <i class="material-icons">download</i> Export CSV
            </button>
            <button class="btn btn-primary" onclick="exportUsers('json')">
                <i class="material-icons">download</i> Export JSON
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="material-icons">people</i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ total_users }}</div>
                <div class="stat-label">Total Users</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="material-icons">check_circle</i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ active_users }}</div>
                <div class="stat-label">Active Users</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="material-icons">admin_panel_settings</i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ staff_users }}</div>
                <div class="stat-label">Staff Users</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="material-icons">verified_user</i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ verified_users }}</div>
                <div class="stat-label">Verified Users</div>
            </div>
        </div>
    </div>

    <!-- User Type Statistics -->
    <div class="stats-grid mt-3">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="material-icons">person</i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ individual_users }}</div>
                <div class="stat-label">Particuliers</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="material-icons">business</i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ company_users }}</div>
                <div class="stat-label">Entreprises</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="material-icons">local_hospital</i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ emergency_users }}</div>
                <div class="stat-label">Services d'urgence</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="material-icons">account_balance</i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ government_users }}</div>
                <div class="stat-label">Gouvernement</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="material-icons">security</i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ law_enforcement_users }}</div>
                <div class="stat-label">Forces de l'ordre</div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="filters-section">
        <form method="get" class="filters-form" id="filters-form">
            <div class="search-box">
                <i class="material-icons">search</i>
                <input 
                    type="text" 
                    name="search" 
                    id="search-input" 
                    placeholder="Search by username, name, or email..." 
                    value="{{ search }}"
                >
            </div>

            <div class="filters-row">
                <div class="filter-group">
                    <label for="user_type">User Type:</label>
                    <select name="user_type" id="user_type" class="filter-select">
                        <option value="">All Types</option>
                        {% for value, label in user_type_choices %}
                        <option value="{{ value }}" {% if selected_user_type == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="verification_status">Verification:</label>
                    <select name="verification_status" id="verification_status" class="filter-select">
                        <option value="">All Statuses</option>
                        {% for value, label in verification_status_choices %}
                        <option value="{{ value }}" {% if selected_verification_status == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="is_active">Status:</label>
                    <select name="is_active" id="is_active" class="filter-select">
                        <option value="">All</option>
                        <option value="true" {% if selected_is_active == 'true' %}selected{% endif %}>Active</option>
                        <option value="false" {% if selected_is_active == 'false' %}selected{% endif %}>Inactive</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="is_staff">Role:</label>
                    <select name="is_staff" id="is_staff" class="filter-select">
                        <option value="">All</option>
                        <option value="true" {% if selected_is_staff == 'true' %}selected{% endif %}>Staff</option>
                        <option value="false" {% if selected_is_staff == 'false' %}selected{% endif %}>Regular</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="sort">Sort By:</label>
                    <select name="sort" id="sort" class="filter-select">
                        <option value="-date_joined" {% if current_sort == '-date_joined' %}selected{% endif %}>Newest First</option>
                        <option value="date_joined" {% if current_sort == 'date_joined' %}selected{% endif %}>Oldest First</option>
                        <option value="username" {% if current_sort == 'username' %}selected{% endif %}>Username A-Z</option>
                        <option value="-username" {% if current_sort == '-username' %}selected{% endif %}>Username Z-A</option>
                        <option value="-last_login" {% if current_sort == '-last_login' %}selected{% endif %}>Last Login</option>
                    </select>
                </div>

                <button type="button" class="btn btn-secondary" id="clear-filters">
                    <i class="material-icons">clear</i> Clear Filters
                </button>
            </div>
        </form>
    </div>

    <!-- Bulk Actions -->
    <div class="bulk-actions" id="bulk-actions" style="display: none;">
        <div class="bulk-info">
            <span id="selected-count">0 selected</span>
        </div>
        <div class="bulk-buttons">
            <select id="bulk-action-select" class="bulk-action-select">
                <option value="">Select Action...</option>
                <option value="activate">Activate</option>
                <option value="deactivate">Deactivate</option>
                <option value="assign_group">Assign Permission Group</option>
                <option value="send_email">Send Email</option>
            </select>
            <button type="button" class="btn btn-primary" id="bulk-action-btn">
                Apply
            </button>
        </div>
    </div>

    <!-- Users Table -->
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th width="40">
                        <input type="checkbox" id="select-all" class="checkbox">
                    </th>
                    <th>Username</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>User Type</th>
                    <th>Verification</th>
                    <th>Status</th>
                    <th>Joined</th>
                    <th>Last Login</th>
                    <th width="120">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>
                        <input type="checkbox" class="item-checkbox" value="{{ user.id }}">
                    </td>
                    <td>
                        <a href="{% url 'administration:user_detail' user.id %}" class="user-link">
                            {{ user.username }}
                        </a>
                        {% if user.is_staff %}
                        <span class="badge badge-staff">Staff</span>
                        {% endif %}
                        {% if user.is_superuser %}
                        <span class="badge badge-superuser">Admin</span>
                        {% endif %}
                    </td>
                    <td>{{ user.get_full_name|default:"-" }}</td>
                    <td>{{ user.email|default:"-" }}</td>
                    <td>
                        {% if user.profile %}
                        <span class="badge badge-type">{{ user.profile.get_user_type_display }}</span>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>
                        {% if user.profile %}
                        <span class="badge badge-{{ user.profile.verification_status }}">
                            {{ user.profile.get_verification_status_display }}
                        </span>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>
                        {% if user.is_active %}
                        <span class="status-badge status-active">Active</span>
                        {% else %}
                        <span class="status-badge status-inactive">Inactive</span>
                        {% endif %}
                    </td>
                    <td>{{ user.date_joined|date:"Y-m-d" }}</td>
                    <td>
                        {% if user.last_login %}
                        {{ user.last_login|date:"Y-m-d H:i" }}
                        {% else %}
                        Never
                        {% endif %}
                    </td>
                    <td class="actions-cell">
                        <a href="{% url 'administration:user_detail' user.id %}" class="btn-icon" title="View">
                            <i class="material-icons">visibility</i>
                        </a>
                        <a href="{% url 'administration:user_edit' user.id %}" class="btn-icon" title="Edit">
                            <i class="material-icons">edit</i>
                        </a>
                        <button 
                            class="btn-icon toggle-status" 
                            data-user-id="{{ user.id }}"
                            data-is-active="{{ user.is_active|yesno:'true,false' }}"
                            title="{% if user.is_active %}Deactivate{% else %}Activate{% endif %}"
                        >
                            <i class="material-icons">
                                {% if user.is_active %}block{% else %}check_circle{% endif %}
                            </i>
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="no-data">
                        <i class="material-icons">info</i>
                        No users found matching your criteria.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <div class="pagination">
        <div class="pagination-info">
            Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ paginator.count }} users
        </div>
        <div class="pagination-controls">
            {% if page_obj.has_previous %}
            <a href="?page=1{% if search %}&search={{ search }}{% endif %}{% if selected_user_type %}&user_type={{ selected_user_type }}{% endif %}{% if selected_verification_status %}&verification_status={{ selected_verification_status }}{% endif %}{% if selected_is_active %}&is_active={{ selected_is_active }}{% endif %}{% if selected_is_staff %}&is_staff={{ selected_is_staff }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}" class="btn btn-sm">First</a>
            <a href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if selected_user_type %}&user_type={{ selected_user_type }}{% endif %}{% if selected_verification_status %}&verification_status={{ selected_verification_status }}{% endif %}{% if selected_is_active %}&is_active={{ selected_is_active }}{% endif %}{% if selected_is_staff %}&is_staff={{ selected_is_staff }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}" class="btn btn-sm">Previous</a>
            {% endif %}
            
            <span class="page-number">Page {{ page_obj.number }} of {{ paginator.num_pages }}</span>
            
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if selected_user_type %}&user_type={{ selected_user_type }}{% endif %}{% if selected_verification_status %}&verification_status={{ selected_verification_status }}{% endif %}{% if selected_is_active %}&is_active={{ selected_is_active }}{% endif %}{% if selected_is_staff %}&is_staff={{ selected_is_staff }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}" class="btn btn-sm">Next</a>
            <a href="?page={{ paginator.num_pages }}{% if search %}&search={{ search }}{% endif %}{% if selected_user_type %}&user_type={{ selected_user_type }}{% endif %}{% if selected_verification_status %}&verification_status={{ selected_verification_status }}{% endif %}{% if selected_is_active %}&is_active={{ selected_is_active }}{% endif %}{% if selected_is_staff %}&is_staff={{ selected_is_staff }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}" class="btn btn-sm">Last</a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-submit form on filter change
document.querySelectorAll('.filter-select').forEach(select => {
    select.addEventListener('change', () => {
        document.getElementById('filters-form').submit();
    });
});

// Debounced search
let searchTimeout;
document.getElementById('search-input').addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        document.getElementById('filters-form').submit();
    }, 500);
});

// Clear filters
document.getElementById('clear-filters').addEventListener('click', () => {
    window.location.href = '{% url "administration:user_list" %}';
});

// Toggle user status
document.querySelectorAll('.toggle-status').forEach(button => {
    button.addEventListener('click', async function() {
        const userId = this.dataset.userId;
        const isActive = this.dataset.isActive === 'true';
        const action = isActive ? 'deactivate' : 'activate';
        
        if (!confirm(`Are you sure you want to ${action} this user?`)) {
            return;
        }
        
        try {
            const response = await fetch(`/administration/users/${userId}/toggle-status/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                location.reload();
            } else {
                alert('Error: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Error toggling user status');
            console.error(error);
        }
    });
});

// Bulk selection
const selectAllCheckbox = document.getElementById('select-all');
const itemCheckboxes = document.querySelectorAll('.item-checkbox');
const bulkActions = document.getElementById('bulk-actions');
const selectedCount = document.getElementById('selected-count');

selectAllCheckbox.addEventListener('change', function() {
    itemCheckboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
    });
    updateBulkActions();
});

itemCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', updateBulkActions);
});

function updateBulkActions() {
    const checkedCount = document.querySelectorAll('.item-checkbox:checked').length;
    selectedCount.textContent = `${checkedCount} selected`;
    bulkActions.style.display = checkedCount > 0 ? 'flex' : 'none';
}

// Bulk action execution
document.getElementById('bulk-action-btn').addEventListener('click', async function() {
    const action = document.getElementById('bulk-action-select').value;
    if (!action) {
        alert('Please select an action');
        return;
    }
    
    const selectedItems = Array.from(document.querySelectorAll('.item-checkbox:checked'))
        .map(cb => cb.value);
    
    if (selectedItems.length === 0) {
        alert('Please select at least one user');
        return;
    }
    
    // Handle different actions
    if (action === 'activate' || action === 'deactivate') {
        if (!confirm(`Are you sure you want to ${action} ${selectedItems.length} user(s)?`)) {
            return;
        }
        
        await executeBulkAction(action, selectedItems);
    } else if (action === 'assign_group') {
        // Show group selection dialog
        const groupId = prompt('Enter Permission Group ID:');
        if (!groupId) return;
        
        await executeBulkAction(action, selectedItems, { group_id: groupId });
    } else if (action === 'send_email') {
        // Show email dialog
        const subject = prompt('Email Subject:');
        if (!subject) return;
        
        const body = prompt('Email Body:');
        if (!body) return;
        
        await executeBulkAction(action, selectedItems, { subject, body });
    }
});

async function executeBulkAction(action, items, extraData = {}) {
    try {
        const response = await fetch('{% url "administration:user_bulk_operations" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: action,
                items: items,
                ...extraData
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            location.reload();
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error performing bulk operation');
        console.error(error);
    }
}

// Export functions
function exportUsers(format) {
    const params = new URLSearchParams(window.location.search);
    params.set('export', format);
    
    // Ask about anonymization
    const anonymize = confirm('Do you want to anonymize personal data (names, emails)?\n\nClick OK to anonymize, Cancel to export full data.');
    if (anonymize) {
        params.set('anonymize', 'true');
    }
    
    window.location.href = `{% url 'administration:user_export' %}?${params.toString()}`;
}
</script>
{% endblock %}
