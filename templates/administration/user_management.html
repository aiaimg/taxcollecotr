{% extends 'base_velzon.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Gestion des Utilisateurs" %}{% endblock %}

{% block extra_css %}
<style>
.user-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-left: 4px solid #007bff;
}

.user-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #007bff;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 18px;
}

.user-name {
    font-weight: 600;
    font-size: 16px;
    color: #333;
}

.user-status {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
}

.status-active {
    background: #d4edda;
    color: #155724;
}

.status-inactive {
    background: #f8d7da;
    color: #721c24;
}

.status-staff {
    background: #d1ecf1;
    color: #0c5460;
}

.text-sm {
    font-size: 14px;
}

.search-box {
    border-radius: 6px;
    border: 1px solid #ddd;
    padding: 8px 12px;
}

.search-box:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}
</style>
{% endblock %}

{% block pagetitle %}
<div class="row">
    <div class="col-12">
        <div class="page-title-box d-sm-flex align-items-center justify-content-between">
            <h4 class="mb-sm-0">{% trans "Gestion des Utilisateurs" %}</h4>
            <div class="page-title-right">
                <ol class="breadcrumb m-0">
                    <li class="breadcrumb-item"><a href="{% url 'administration:dashboard' %}">{% trans "Tableau de bord" %}</a></li>
                    <li class="breadcrumb-item active">{% trans "Utilisateurs" %}</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    <!-- Filters -->
    <div class="filter-card">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                <label class="form-label">{% trans "Rechercher" %}</label>
                <input type="text" name="search" class="form-control search-box" 
                       placeholder="{% trans "Nom, email, nom d'utilisateur..." %}" value="{{ search }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">{% trans "Statut" %}</label>
                <select name="status" class="form-select">
                    <option value="">{% trans "Tous les statuts" %}</option>
                    <option value="active" {% if selected_status == 'active' %}selected{% endif %}>{% trans "Actifs" %}</option>
                    <option value="inactive" {% if selected_status == 'inactive' %}selected{% endif %}>{% trans "Inactifs" %}</option>
                    <option value="staff" {% if selected_status == 'staff' %}selected{% endif %}>{% trans "Staff" %}</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="fas fa-search me-2"></i>{% trans "Filtrer" %}
                </button>
                <a href="{% url 'administration:user_management' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-2"></i>{% trans "Reset" %}
                </a>
            </div>
            <div class="col-md-2 text-end">
                {% blocktrans count user_count=users|length %}
                <small class="text-muted">{{ user_count }} utilisateur</small>
                {% plural %}
                <small class="text-muted">{{ user_count }} utilisateurs</small>
                {% endblocktrans %}
            </div>
        </form>
    </div>

    <!-- User List -->
    <div class="row">
        {% for user in users %}
        <div class="col-xl-6 col-lg-12">
            <div class="user-card">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center mb-3">
                            <div class="user-avatar me-3">
                                {{ user.first_name|first|default:user.username|first|upper }}
                            </div>
                            <div>
                                <div class="user-name">
                                    {{ user.get_full_name|default:user.username }}
                                </div>
                                <div class="text-muted">@{{ user.username }}</div>
                            </div>
                        </div>
                        
                        <div class="row text-sm">
                            <div class="col-6">
                                <strong>{% trans "Email:" %}</strong><br>
                                <span class="text-muted">{% if user.email %}{{ user.email }}{% else %}{% trans "Non renseigné" %}{% endif %}</span>
                            </div>
                            <div class="col-6">
                                <strong>{% trans "Statut:" %}</strong><br>
                                {% if user.is_staff %}
                                    <span class="user-status status-staff">{% trans "Staff" %}</span>
                                {% elif user.is_active %}
                                    <span class="user-status status-active">{% trans "Actif" %}</span>
                                {% else %}
                                    <span class="user-status status-inactive">{% trans "Inactif" %}</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row text-sm mt-2">
                            <div class="col-6">
                                <strong>{% trans "Inscrit le:" %}</strong><br>
                                <span class="text-muted">{{ user.date_joined|date:"d/m/Y" }}</span>
                            </div>
                            <div class="col-6">
                                <strong>{% trans "Dernière connexion:" %}</strong><br>
                                <span class="text-muted">
                                    {% if user.last_login %}
                                        {{ user.last_login|date:"d/m/Y H:i" }}
                                    {% else %}
                                        {% trans "Jamais connecté" %}
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        
                        <!-- User vehicles count -->
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-car me-1"></i>
                                {% blocktrans count vcount=user.vehicules.count %}{{ vcount }} véhicule{% plural %}{{ vcount }} véhicules{% endblocktrans %}
                            </small>
                        </div>
                    </div>
                    
                    <div class="col-md-4 text-end">
                        <div class="btn-group-vertical" role="group">
                            {% if not user.is_superuser %}
                            <form method="post" action="{% url 'administration:toggle_user_status' user.id %}" class="mb-1">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-outline-{% if user.is_active %}warning{% else %}success{% endif %} btn-sm">
                                    <i class="fas fa-{% if user.is_active %}pause{% else %}play{% endif %} me-1"></i>
                                    {% if user.is_active %}{% trans "Désactiver" %}{% else %}{% trans "Activer" %}{% endif %}
                                </button>
                            </form>
                            {% endif %}
                            
                            <a href="{% url 'vehicles:vehicle_list' %}?proprietaire={{ user.id }}" 
                               class="btn btn-outline-info btn-sm mb-1">
                                <i class="fas fa-car me-1"></i>{% trans "Véhicules" %}
                            </a>
                            
                            <a href="{% url 'payments:list' %}?utilisateur={{ user.id }}" 
                               class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-credit-card me-1"></i>{% trans "Paiements" %}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="text-center py-5">
                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">{% trans "Aucun utilisateur trouvé" %}</h5>
                <p class="text-muted">
                    {% if search or selected_status %}
                        {% trans "Aucun utilisateur ne correspond à vos critères de recherche." %}
                    {% else %}
                        {% trans "Aucun utilisateur n'est encore enregistré sur la plateforme." %}
                    {% endif %}
                </p>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <div class="d-flex justify-content-center mt-4">
        <nav aria-label="{% trans 'Navigation des pages' %}">
            <ul class="pagination">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if search %}search={{ search }}&{% endif %}{% if selected_status %}status={{ selected_status }}&{% endif %}page=1">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?{% if search %}search={{ search }}&{% endif %}{% if selected_status %}status={{ selected_status }}&{% endif %}page={{ page_obj.previous_page_number }}">
                            <i class="fas fa-angle-left"></i>
                        </a>
                    </li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?{% if search %}search={{ search }}&{% endif %}{% if selected_status %}status={{ selected_status }}&{% endif %}page={{ num }}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if search %}search={{ search }}&{% endif %}{% if selected_status %}status={{ selected_status }}&{% endif %}page={{ page_obj.next_page_number }}">
                            <i class="fas fa-angle-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?{% if search %}search={{ search }}&{% endif %}{% if selected_status %}status={{ selected_status }}&{% endif %}page={{ page_obj.paginator.num_pages }}">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-submit form on select change
document.querySelector('select[name="status"]').addEventListener('change', function() {
    this.form.submit();
});

// Confirm user status toggle
document.querySelectorAll('form[action*="toggle-status"]').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const button = this.querySelector('button');
        const action = button.textContent.trim();
        const formElement = this;
        
        Notifications.confirm(
            `${action} cet utilisateur?`,
            `Êtes-vous sûr de vouloir ${action.toLowerCase()} cet utilisateur?`
        ).then((result) => {
            if (result.isConfirmed) {
                Notifications.loading('Traitement en cours...');
                formElement.submit();
            }
        });
    });
});
</script>
{% endblock %}