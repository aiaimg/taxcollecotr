{% extends "base_velzon.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Détails du véhicule" %} - {{ object.plaque_immatriculation }}{% endblock title %}

{% block pagetitle %}
<div class="row">
    <div class="col-12">
        <div class="page-title-box d-sm-flex align-items-center justify-content-between">
            <h4 class="mb-sm-0">{% trans "Détails du véhicule" %}</h4>
            <div class="page-title-right">
                <ol class="breadcrumb m-0">
                    <li class="breadcrumb-item"><a href="{% url 'core:velzon_dashboard' %}">{% trans "Tableau de Bord" %}</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'vehicles:vehicle_list' %}">{% trans "Véhicules" %}</a></li>
                    <li class="breadcrumb-item active">{{ object.plaque_immatriculation }}</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock pagetitle %}

{% block extra_css %}
<style>
.status-badge {
    font-size: 0.875rem;
    padding: 0.375rem 0.75rem;
}

.vehicle-card {
    border: 1px solid var(--vz-border-color);
    border-radius: 0.5rem;
    transition: all 0.3s ease;
}

.vehicle-card:hover {
    box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
}

.info-item {
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--vz-border-color);
}

.info-item:last-child {
    border-bottom: none;
}

.info-label {
    font-weight: 600;
    color: var(--vz-dark);
    margin-bottom: 0.25rem;
}

.info-value {
    color: var(--vz-gray-600);
}

.tax-amount {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--vz-primary);
}
</style>
{% endblock extra_css %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- Vehicle Information Card -->
        <div class="card">
            <div class="card-header border-bottom-dashed">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <i class="ri-car-line ri-2x text-primary me-3"></i>
                        <div>
                            <h5 class="mb-0">{{ object.plaque_immatriculation }}</h5>
                            <small class="text-muted">{{ object.type_vehicule }}</small>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        {% if object.is_paid %}
                            <span class="badge bg-success status-badge">
                                <i class="ri-check-line me-1"></i>
                                {% trans "Taxe payée" %}
                            </span>
                        {% else %}
                            <span class="badge bg-warning status-badge">
                                <i class="ri-time-line me-1"></i>
                                {% trans "Taxe non payée" %}
                            </span>
                        {% endif %}
                        
                        {% if user == object.utilisateur %}
                            <a href="{% url 'vehicles:vehicle_edit' object.pk %}" class="btn btn-soft-primary btn-sm">
                                <i class="ri-edit-line me-1"></i>
                                {% trans "Modifier" %}
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-item">
                            <div class="info-label">{% trans "Plaque d'immatriculation" %}</div>
                            <div class="info-value h5">{{ object.plaque_immatriculation }}</div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-label">{% trans "Type de véhicule" %}</div>
                            <div class="info-value">{{ object.type_vehicule }}</div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-label">{% trans "Catégorie" %}</div>
                            <div class="info-value">{{ object.categorie_vehicule }}</div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-label">{% trans "Source d'énergie" %}</div>
                            <div class="info-value">
                                {% if object.source_energie == 'Electrique' %}
                                    <i class="ri-flashlight-line text-success me-1"></i>
                                {% elif object.source_energie == 'Hybride' %}
                                    <i class="ri-leaf-line text-warning me-1"></i>
                                {% else %}
                                    <i class="ri-oil-line text-danger me-1"></i>
                                {% endif %}
                                {{ object.source_energie }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="info-item">
                            <div class="info-label">{% trans "Puissance fiscale" %}</div>
                            <div class="info-value">{{ object.puissance_fiscale_cv }} CV</div>
                        </div>
                        
                        {% if object.cylindree_cm3 %}
                        <div class="info-item">
                            <div class="info-label">{% trans "Cylindrée" %}</div>
                            <div class="info-value">{{ object.cylindree_cm3 }} cm³</div>
                        </div>
                        {% endif %}
                        
                        <div class="info-item">
                            <div class="info-label">{% trans "Date de première circulation" %}</div>
                            <div class="info-value">{{ object.date_premiere_circulation|date:"d/m/Y" }}</div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-label">{% trans "Âge du véhicule" %}</div>
                            <div class="info-value">{{ object.age_vehicule }} {% trans "ans" %}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Owner Information Card -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="ri-user-line me-2"></i>
                    {% trans "Propriétaire" %}
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-item">
                            <div class="info-label">{% trans "Nom" %}</div>
                            <div class="info-value">{{ object.utilisateur.get_full_name|default:object.utilisateur.username }}</div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-label">{% trans "Email" %}</div>
                            <div class="info-value">{{ object.utilisateur.email }}</div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="info-item">
                            <div class="info-label">{% trans "Téléphone" %}</div>
                            <div class="info-value">{{ object.utilisateur.profile.phone|default:"-" }}</div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-label">{% trans "Date d'inscription" %}</div>
                            <div class="info-value">{{ object.created_at|date:"d/m/Y H:i" }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Payments Card -->
        {% if payments %}
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="ri-money-dollar-circle-line me-2"></i>
                    {% trans "Paiements récents" %}
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>{% trans "Date" %}</th>
                                <th>{% trans "Montant" %}</th>
                                <th>{% trans "Méthode" %}</th>
                                <th>{% trans "Statut" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in payments %}
                            <tr>
                                <td>{{ payment.date_paiement|date:"d/m/Y" }}</td>
                                <td>{{ payment.montant_paye_ariary|floatformat:0 }} Ar</td>
                                <td>{{ payment.methode_paiement }}</td>
                                <td>
                                    {% if payment.statut == 'paye' %}
                                        <span class="badge bg-success">
                                            <i class="ri-check-line me-1"></i>
                                            {% trans "Payé" %}
                                        </span>
                                    {% else %}
                                        <span class="badge bg-warning">
                                            <i class="ri-time-line me-1"></i>
                                            {% trans "En attente" %}
                                        </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                {% if payments|length > 3 %}
                <div class="text-center mt-3">
                    <a href="{% url 'payments:payment_list' %}?vehicule={{ object.pk }}" class="btn btn-soft-primary btn-sm">
                        {% trans "Voir tous les paiements" %}
                        <i class="ri-arrow-right-line ms-1"></i>
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="col-lg-4">
        <!-- Tax Information Card -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="ri-calculator-line me-2"></i>
                    {% trans "Taxe annuelle" %}
                </h5>
            </div>
            <div class="card-body text-center">
                {% if object.is_exempt %}
                    <div class="mb-3">
                        <i class="ri-shield-line ri-3x text-success"></i>
                    </div>
                    <h5 class="text-success mb-2">{% trans "Exonéré" %}</h5>
                    <p class="text-muted mb-0">{{ object.exemption_reason }}</p>
                {% else %}
                    <div class="tax-amount mb-2">{{ object.tax_amount|floatformat:0 }} Ar</div>
                    <p class="text-muted mb-3">{% trans "Taxe pour l'année" %} {{ current_year|default:"2025" }}</p>
                    
                    {% if not object.is_paid %}
                        <a href="{% url 'payments:create_payment' %}?vehicule={{ object.pk }}" class="btn btn-primary w-100">
                            <i class="ri-money-dollar-circle-line me-2"></i>
                            {% trans "Payer la taxe" %}
                        </a>
                    {% endif %}
                {% endif %}
            </div>
        </div>
        
        <!-- Quick Actions Card -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="ri-lightbulb-line me-2"></i>
                    {% trans "Actions rapides" %}
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'vehicles:vehicle_edit' object.pk %}" class="btn btn-soft-primary">
                        <i class="ri-edit-line me-2"></i>
                        {% trans "Modifier le véhicule" %}
                    </a>
                    
                    <a href="{% url 'payments:payment_list' %}?vehicule={{ object.pk }}" class="btn btn-soft-info">
                        <i class="ri-money-dollar-circle-line me-2"></i>
                        {% trans "Historique des paiements" %}
                    </a>
                    
                    <a href="{% url 'vehicles:vehicle_list' %}" class="btn btn-soft-secondary">
                        <i class="ri-arrow-left-line me-2"></i>
                        {% trans "Retour à la liste" %}
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Tax Calculation Info Card -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="ri-information-line me-2"></i>
                    {% trans "Calcul de la taxe" %}
                </h5>
            </div>
            <div class="card-body">
                <div class="small text-muted">
                    <p class="mb-2">
                        <strong>{% trans "Base de calcul:" %}</strong>
                    </p>
                    <ul class="mb-0">
                        <li>{% trans "Puissance fiscale: " %}{{ object.puissance_fiscale_cv }} CV</li>
                        <li>{% trans "Source d'énergie: " %}{{ object.source_energie }}</li>
                        <li>{% trans "Âge du véhicule: " %}{{ object.age_vehicule }} {% trans "ans" %}</li>
                        <li>{% trans "Catégorie: " %}{{ object.categorie_vehicule }}</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add any additional JavaScript for vehicle detail page
    console.log('Vehicle detail page loaded');
});
</script>
{% endblock extra_js %}